<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garment T&A Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- We now only rely on core Moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Color logic for the dates */
        .result-cell {
            font-weight: 600;
            color: #10b981; /* Emerald 600 - Safe/Planned Green */
        }
        .text-red-600 { /* Important Constraints/Triggers are highlighted */
             color: #dc2626; 
        }

        .deadline-header {
            background-color: #0d9488; /* Teal 600 */
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .accordion-button {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        /* Ensure dates in cells don't wrap and adjust width of the entire cell */
        #resultsTableBody td, #forwardResultsTableBody td {
            white-space: nowrap;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content rounded-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex justify-between items-center">
                T&A Planner Settings 
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-900 text-3xl font-light">&times;</button>
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- A. Lead Time Settings -->
                <div>
                    <h3 class="text-lg font-semibold text-teal-700 mb-2 border-b">1. Lead Time Days (Working/Calendar)</h3>
                    <div id="ltSettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white">
                        <!-- LT inputs rendered here -->
                    </div>
                </div>

                <!-- B. Holiday Settings -->
                <div>
                    <h3 class="text-lg font-semibold text-teal-700 mb-2 border-b">2. Long Holidays (Start/End Date)</h3>
                    <div id="holidaySettingsContainer" class="space-y-3 p-3 border rounded-lg bg-white">
                        <!-- Holiday inputs rendered here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Note: Dates are inclusive. Weekends (Sat/Sun) are always excluded.</p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 mt-6">
                <button id="saveSettingsBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>
    <!-- End Settings Modal -->

    <div class="max-w-5xl mx-auto card bg-white rounded-xl overflow-hidden">
        <header class="deadline-header p-6 flex justify-between items-start">
            <div>
                <h1 class="text-2xl sm:text-3xl font-bold text-white mb-0 leading-tight">Garment Lead Time (T&A) Planner</h1>
                <p class="text-sm text-gray-100">Backward Planning Schedule with Weekend & Holiday Constraints</p>
            </div>
            <button id="settingsTriggerBtn" class="text-white hover:text-gray-200 transition duration-150 p-2 rounded-full border border-teal-400">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 18H7.5m10.5-6h-9.75m9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0M3.75 12H7.5" />
                </svg>
            </button>
        </header>

        <main class="p-4 sm:p-6">
            
            <!-- Input & Add Row -->
            <div class="mb-6 flex justify-between items-center pb-3 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800">1. Backward Planning (Input: Customer Delivery Date)</h2>
                <button onclick="addRow()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-150">
                    + Add Row (New Season)
                </button>
            </div>
            
            <!-- Backward Results Table -->
            <div class="mb-6">
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg border">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">Season / Row</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">Customer Delivery Date (CDD)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[160px] whitespace-normal">ORDERS DUE DATE (Mon-Fri)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[140px] whitespace-normal">ETA / WH USA (14D Cal)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">Plan Fabric ETD (60D Cal/H)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[170px] whitespace-normal">Plan Fab inhouse (45D Cal/H, Sun-Thu)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[170px] whitespace-normal">ETD ex-Bdesh (60D Cal/H, Sunday)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[40px] whitespace-normal">Action</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Forward Planning Section (Collapsible) -->
            <div class="mb-6 border border-gray-200 rounded-lg">
                <div class="accordion-button bg-gray-200 hover:bg-gray-300 p-4 rounded-lg flex justify-between items-center" onclick="toggleSection('forwardPlanningSection')">
                    <h2 class="text-xl font-semibold text-gray-800">2. Forward Planning (Input: Orders Due Date / Booking Trigger)</h2>
                    <span id="forwardPlanningIcon" class="text-2xl transform transition-transform duration-300">+</span>
                </div>
                <div id="forwardPlanningSection" class="p-4 bg-gray-50 hidden">
                    
                    <div class="mb-4 flex justify-between items-center pb-3 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-700">What-If Scenarios (Orders Due Date -> CDD)</h3>
                        <button onclick="addForwardRow()" class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium py-2 px-4 rounded-md transition duration-150">
                            + Add Forward Row
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 rounded-lg border">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">Scenario</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">ORDERS DUE DATE (Mon-Fri Input)</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[160px] whitespace-normal">Plan Fabric ETD</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[170px] whitespace-normal">Plan Fab inhouse</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[170px] whitespace-normal">ETD ex-Bdesh (Sunday)</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase text-red-600 w-[140px] whitespace-normal">ETA / WH USA</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[140px] whitespace-normal">CUSTOMER DELIVERY DATE (CDD)</th>
                                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase w-[40px] whitespace-normal">Action</th>
                                </tr>
                            </thead>
                            <tbody id="forwardResultsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Forward Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- End Forward Planning Section -->

            <!-- Constraint Information -->
            <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-300 text-sm">
                <h3 class="font-semibold text-yellow-700 mb-2">Constraint Notes</h3>
                <ul class="list-disc list-inside ml-4 text-gray-700 text-xs">
                    <li><span class="font-medium text-red-600">ETD ex-Bdesh:</span> **MUST** fall on a Sunday (vessel day).</li>
                    <li><span class="font-medium text-red-600">Plan Fab inhouse:</span> **MUST** fall on Monday - Thursday (Inhouse Receiving).</li>
                    <li><span class="font-medium text-red-600">ETA / CDD:</span> **MUST** fall on Monday - Friday (Warehouse Receiving).</li>
                    <li><span class="font-medium">Calendar/H (Cal/H):</span> Calculation counts **7 days a week**, but excludes **Long Holidays** defined in Settings.</li>
                </ul>
            </div>

        </main>

        <!-- Footer Credit -->
        <footer class="bg-gray-100 p-3 text-center border-t">
            <p class="text-xs text-gray-600 font-medium">
                Musfikur Rahman - Perry Ellis Bangladesh | Copyright © 2025
            </p>
        </footer>
    </div>

    <script>
        // --- GLOBAL CONFIGS & DEFAULTS (Moved to top for scope fix) ---
        const DATE_FORMAT = 'YYYY-MM-DD';
        const DISPLAY_FORMAT = 'DD-MMM-YYYY';

        // Default Lead Times (Calendar Days / Working Days)
        const DEFAULT_LTS = [
            { name: "CDD to ETA LT", days: 14, type: "calendar" }, // 14D Cal
            { name: "ETA to ETD LT", days: 60, type: "calendar" }, // 60D Cal
            { name: "ETD to Fab Inhouse LT", days: 45, type: "calendar_holiday" }, // 45D Cal/H (BD - Eid)
            { name: "Fab Inhouse to Fab ETD LT", days: 30, type: "calendar" }, // 30D Cal (Sea Transit: NO HOLIDAYS/WEEKENDS)
            { name: "Fabric ETD to Orders Due LT", days: 60, type: "calendar_holiday" }, // 60D Cal/H (China - CNY/Oct)
        ];

        // Default Holiday Blocks (Start/End) - YYYY-MM-DD
        const DEFAULT_HOLIDAYS = [
            { name: "CNY Mill Closing", start: "2026-02-03", end: "2026-03-03" },
            { name: "1st Eid Holiday", start: "2026-03-18", end: "2026-03-29" },
            { name: "2nd Eid Holiday", start: "2026-05-23", end: "2026-05-31" },
            { name: "Golden October", start: "2026-10-01", end: "2026-10-10" },
        ];
        // --- END GLOBAL CONFIGS ---


        let LTs = JSON.parse(localStorage.getItem('ltSettings')) || DEFAULT_LTS;
        let HOLIDAY_BLOCKS = JSON.parse(localStorage.getItem('holidaySettings')) || DEFAULT_HOLIDAYS;

        let dataRows = JSON.parse(localStorage.getItem('dataRows')) || [];
        let forwardDataRows = JSON.parse(localStorage.getItem('forwardDataRows')) || [];


        // --- MOMENT.JS CONFIGURATION & CUSTOM CALCULATION LOGIC ---

        function generateHolidayDates(blocks) {
            let dates = [];
            blocks.forEach(block => {
                let start = moment(block.start);
                let end = moment(block.end);
                if (start.isValid() && end.isValid()) {
                    let current = start;
                    while (current.isSameOrBefore(end)) {
                        dates.push(current.format(DATE_FORMAT));
                        current.add(1, 'day');
                    }
                }
            });
            return dates;
        }

        // Global holiday set for quick lookup
        let GLOBAL_HOLIDAYS = new Set();
        let CHINA_HOLIDAYS = new Set();
        let BD_HOLIDAYS = new Set();

        function updateHolidaySet() {
            GLOBAL_HOLIDAYS.clear();
            CHINA_HOLIDAYS.clear();
            BD_HOLIDAYS.clear();

            HOLIDAY_BLOCKS.forEach(block => {
                let start = moment(block.start);
                let end = moment(block.end);
                
                if (start.isValid() && end.isValid()) {
                    let current = moment(start);
                    while (current.isSameOrBefore(end)) {
                        const date = current.format(DATE_FORMAT);
                        GLOBAL_HOLIDAYS.add(date);

                        // Split holidays for conditional LT use
                        if (block.name.includes("CNY") || block.name.includes("October")) {
                            CHINA_HOLIDAYS.add(date);
                        }
                        if (block.name.includes("Eid")) {
                            BD_HOLIDAYS.add(date);
                        }

                        current.add(1, 'day');
                    }
                }
            });
        }

        // Custom function to subtract/add calendar days, skipping only specified holidays
        function subtractDaysSkippingHolidays(startDate, daysToSubtract, skipSet) {
            let resultDate = moment(startDate);
            let daysCounted = 0;
            
            // Step determines direction: positive for backward (subtract), negative for forward (add)
            const step = daysToSubtract > 0 ? -1 : 1;
            const targetDays = Math.abs(daysToSubtract);
            
            while (daysCounted < targetDays) {
                resultDate.add(step, 'day');
                // Check if the resulting day is a holiday in the specific set
                if (!skipSet.has(resultDate.format(DATE_FORMAT))) {
                    daysCounted++;
                }
            }
            return resultDate;
        }
        
        // Custom function for Working Days (Mon-Fri) Subtract
        function subtractWorkingDays(startDate, daysToSubtract) {
            let resultDate = moment(startDate);
            let daysCounted = 0;
            
            while (daysCounted < daysToSubtract) {
                resultDate.subtract(1, 'day');
                const isWeekend = resultDate.isoWeekday() === 6 || resultDate.isoWeekday() === 7; // 6=Sat, 7=Sun
                const isHoliday = GLOBAL_HOLIDAYS.has(resultDate.format(DATE_FORMAT));

                if (!isWeekend && !isHoliday) {
                    daysCounted++;
                }
            }
            return resultDate;
        }

         // Custom function for Working Days (Mon-Fri) Add 
        function addWorkingDays(startDate, daysToAdd) {
            let resultDate = moment(startDate);
            let daysCounted = 0;
            
            while (daysCounted < daysToAdd) {
                resultDate.add(1, 'day');
                const isWeekend = resultDate.isoWeekday() === 6 || resultDate.isoWeekday() === 7; // 6=Sat, 7=Sun
                const isHoliday = GLOBAL_HOLIDAYS.has(resultDate.format(DATE_FORMAT));

                if (!isWeekend && !isHoliday) {
                    daysCounted++;
                }
            }
            return resultDate;
        }


        // --- UTILITY CONSTRAINTS ---

        function getLTByName(name) {
            return LTs.find(lt => lt.name.includes(name)) || { days: 0, type: 'working' };
        }

        // Constraint 1: ORDERS DUE DATE must be Mon-Fri (Backward only)
        function applyMonFriConstraint(date) {
            let workingDate = moment(date);
            while (workingDate.isoWeekday() === 6 || workingDate.isoWeekday() === 7) { // 6=Sat, 7=Sun
                workingDate.subtract(1, 'day');
            }
            return workingDate;
        }
        
        // Constraint 2: Fab Inhouse must be Sun-Thu (Forward or Backward)
        function applySunThuConstraint(date, direction = 'backward') {
            let resultDate = moment(date);
            const isFriday = resultDate.isoWeekday() === 5; // 5=Fri
            const isSaturday = resultDate.isoWeekday() === 6; // 6=Sat

            if (direction === 'backward') {
                 if (isFriday) {
                    resultDate.subtract(1, 'day'); // Friday -> Thursday
                } else if (isSaturday) {
                    resultDate.subtract(2, 'days'); // Saturday -> Thursday
                }
            } else { // Forward (used in recalculation and forward schedule)
                if (isFriday) {
                    resultDate.add(3, 'days'); // Friday -> Monday
                } else if (isSaturday) {
                    resultDate.add(2, 'days'); // Saturday -> Monday
                }
            }
            
            return resultDate;
        }

        // Constraint 3: ETD ex-Bdesh must be Sunday (Backward or Forward)
        function applySundayConstraint(date) {
            let sundaysDate = moment(date);
            // Day() returns 0 for Sunday. We need the nearest Sunday ON OR BEFORE the calculated date.
            while (sundaysDate.day() !== 0) { // 0 is Sunday
                sundaysDate.subtract(1, 'day');
            }
            return sundaysDate;
        }

        // Constraint 4: ETA/CDD must be Mon-Fri (Forward only)
        function applyMonFriConstraintForward(date) {
            let workingDate = moment(date);
            while (workingDate.isoWeekday() === 6 || workingDate.isoWeekday() === 7) { // 6=Sat, 7=Sun
                workingDate.add(1, 'day');
            }
            return workingDate;
        }


        // Helper function to apply LTs based on type
        function applyLTSeparator(startDate, lt) {
            // Determine which holiday set to use for calendar_holiday
            let skipSet = new Set();
            if (lt.name.includes("Fabric ETD to Orders Due")) { // CNY/Oct Zone
                skipSet = CHINA_HOLIDAYS;
            } else if (lt.name.includes("ETD to Fab Inhouse")) { // Eid Zone (BD Production)
                skipSet = BD_HOLIDAYS;
            } else if (lt.name.includes("Fab Inhouse to Fab ETD")) { 
                // Fix: Fab Inhouse to Fab ETD LT is now simple calendar (LT 30)
                skipSet = new Set(); 
            } else {
                 skipSet = new Set(); // No holidays for Sea Transit / Mon-Fri working days
            }


            if (lt.type === 'working') {
                return subtractWorkingDays(startDate, lt.days);
            } else if (lt.type === 'calendar') {
                return moment(startDate).subtract(lt.days, 'days');
            } else if (lt.type === 'calendar_holiday') {
                return subtractDaysSkippingHolidays(startDate, lt.days, skipSet);
            }
            return moment(startDate);
        }

        // Helper function to apply FORWARD LTS based on type
        function applyForwardLTSeparator(startDate, lt) {
            let skipSet = new Set();
            if (lt.name.includes("Fabric ETD to Orders Due")) { // CNY/Oct Zone
                skipSet = CHINA_HOLIDAYS;
            } else if (lt.name.includes("ETD to Fab Inhouse")) { // Eid Zone (BD Production)
                skipSet = BD_HOLIDAYS;
            } else if (lt.name.includes("Fab Inhouse to Fab ETD")) {
                 skipSet = new Set(); // No holidays for Fab Inhouse to Fab ETD
            } else {
                 skipSet = new Set(); // No holidays for Sea Transit / Mon-Fri working days
            }

            if (lt.type === 'working') {
                return addWorkingDays(startDate, lt.days);
            } else if (lt.type === 'calendar') {
                return moment(startDate).add(lt.days, 'days');
            } else if (lt.type === 'calendar_holiday') {
                // Negative subtraction = Addition
                return subtractDaysSkippingHolidays(startDate, -lt.days, skipSet); 
            }
            return moment(startDate);
        }


        // --- BACKWARD CALCULATION (Main Table) ---

        function calculateSchedule(cddInput) {
            const cdd = moment(cddInput);
            if (!cdd.isValid()) return {};

            // Get all LTs from settings
            const ltEtaToCdd = getLTByName('CDD to ETA LT'); 
            const ltEtdToEta = getLTByName('ETA to ETD LT'); 
            const ltFabInhouseToEtd = getLTByName('ETD to Fab Inhouse LT'); 
            const ltFabEtdToFabInhouse = getLTByName('Fab Inhouse to Fab ETD LT'); 
            const ltOrdersDueToFabEtd = getLTByName('Fabric ETD to Orders Due LT'); 


            // 1. CDD Constraint (Backward - Mon-Fri)
            const cddConstrained = applyMonFriConstraint(cdd);

            // 2. ETA / WH USA (CDD - 14 Calendar Days)
            const etaWhUSAInitial = applyLTSeparator(cddConstrained, ltEtaToCdd);
            // Apply Mon-Fri Constraint
            const etaWhUSA = applyMonFriConstraint(etaWhUSAInitial);

            // 3. ETD ex-Bdesh (ETA - 60 Cal Days)
            const etdExBdeshInitial = applyLTSeparator(etaWhUSA, ltEtdToEta);
            // Apply Sunday Constraint
            const etdExBdesh = applySundayConstraint(etdExBdeshInitial);

            // 4. Plan Fab inhouse (ETD - 45 Cal/H Days)
            const planFabInhouseInitial = applyLTSeparator(etdExBdesh, ltFabInhouseToEtd);
            // Apply Sun-Thu constraint (Backward)
            const planFabInhouse = applySunThuConstraint(planFabInhouseInitial, 'backward');

            // 5. Plan Fabric ETD (Fab Inhouse - 30 Cal/H Days)
            const planFabricETD = applyLTSeparator(planFabInhouse, ltFabEtdToFabInhouse);
            
            // 6. ORDERS DUE DATE (Fabric ETD - 60 Cal/H Days)
            let ordersDueDateInitial = applyLTSeparator(planFabricETD, ltOrdersDueToFabEtd);
            // Apply Mon-Fri constraint
            const ordersDueDate = applyMonFriConstraint(ordersDueDateInitial);


            // --- Recalculate FORWARD from the constrained ORDERS DUE DATE (Final Schedule) ---
            
            const schedule = {};
            schedule.OrdersDue = ordersDueDate;
            
            // Fabric ETD (Orders Due + 60 Cal/H Days)
            let fabEtdForward = applyForwardLTSeparator(schedule.OrdersDue.format(DATE_FORMAT), ltOrdersDueToFabEtd);
            schedule.FabricETD = applyMonFriConstraintForward(fabEtdForward); 

            // Fab Inhouse (Fabric ETD + 30 Cal/H Days) -> Apply Sun-Thu Constraint (Forward)
            let fabInhouseForward = applyForwardLTSeparator(schedule.FabricETD.format(DATE_FORMAT), ltFabEtdToFabInhouse); 
            schedule.FabInhouse = applySunThuConstraint(fabInhouseForward, 'forward');

            // ETD ex-Bdesh (Fab Inhouse + 45 Cal/H Days) -> Apply Sunday Constraint (Forward)
            let etdExBdeshForward = applyForwardLTSeparator(schedule.FabInhouse.format(DATE_FORMAT), ltFabInhouseToEtd);
            schedule.ETDBdesh = applySundayConstraint(etdExBdeshForward);
            
            // ETA WH USA (ETD + 60 Calendar Days) -> Apply Mon-Fri Constraint (Forward)
            let etaForward = applyForwardLTSeparator(schedule.ETDBdesh.format(DATE_FORMAT), ltEtdToEta);
            schedule.ETA = applyMonFriConstraintForward(etaForward);
            
            // CDD (ETA + 14 Calendar Days) -> Apply Mon-Fri Constraint (Forward)
            let cddForward = applyForwardLTSeparator(schedule.ETA.format(DATE_FORMAT), ltEtaToCdd);
            schedule.CDD = applyMonFriConstraintForward(cddForward);


            return {
                CDD: schedule.CDD.format(DISPLAY_FORMAT),
                ETA: schedule.ETA.format(DISPLAY_FORMAT),
                OrdersDue: schedule.OrdersDue.format(DISPLAY_FORMAT),
                FabricETD: schedule.FabricETD.format(DISPLAY_FORMAT),
                FabInhouse: schedule.FabInhouse.format(DISPLAY_FORMAT),
                ETDBdesh: schedule.ETDBdesh.format(DISPLAY_FORMAT),
                CDD_CHECK: schedule.CDD.isSameOrAfter(cdd, 'day') ? '' : '⚠️ LT Violation' 
            };
        }

        // --- FORWARD CALCULATION (Forward Table) ---

        function calculateForwardSchedule(ordersDateInput) {
            const ordersDueDate = moment(ordersDateInput);
            
            // Apply Mon-Fri constraint to the input date
            const ordersDueDateConstrained = applyMonFriConstraint(ordersDueDate);

            if (!ordersDueDateConstrained.isValid()) return {};

            // Get all LTs from settings
            const ltEtaToCdd = getLTByName('CDD to ETA LT');
            const ltEtdToEta = getLTByName('ETA to ETD LT');
            const ltFabInhouseToEtd = getLTByName('ETD to Fab Inhouse LT');
            const ltFabEtdToFabInhouse = getLTByName('Fab Inhouse to Fab ETD LT');
            const ltOrdersDueToFabEtd = getLTByName('Fabric ETD to Orders Due LT');

            const schedule = {};
            
            // Orders Due is the fixed constrained point
            schedule.OrdersDue = ordersDueDateConstrained;
            
            // 1. Plan Fabric ETD (Orders Due Date + 60 Cal/H Days)
            schedule.FabricETD = applyForwardLTSeparator(schedule.OrdersDue.format(DATE_FORMAT), ltOrdersDueToFabEtd);
            
            // 2. Plan Fab inhouse (Fabric ETD + 30 Cal/H Days) -> Apply Sun-Thu Constraint (Forward)
            let fabInhouseInitial = applyForwardLTSeparator(schedule.FabricETD.format(DATE_FORMAT), ltFabEtdToFabInhouse);
            schedule.FabInhouse = applySunThuConstraint(fabInhouseInitial, 'forward');

            // 3. ETD ex-Bdesh (Fab Inhouse + 45 Cal/H Days)
            let etdExBdeshInitial = applyForwardLTSeparator(schedule.FabInhouse.format(DATE_FORMAT), ltFabInhouseToEtd);

            // Apply Sunday Constraint
            const etdExBdesh = applySundayConstraint(etdExBdeshInitial);
            schedule.ETDBdesh = etdExBdesh;
            
            // 4. ETA WH USA (ETD + 60 Calendar Days) -> Apply Mon-Fri Constraint (Forward)
            let etaForward = applyForwardLTSeparator(schedule.ETDBdesh.format(DATE_FORMAT), ltEtdToEta);
            schedule.ETA = applyMonFriConstraintForward(etaForward);
            
            // 5. Customer Delivery Date (ETA + 14 Calendar Days) -> Apply Mon-Fri Constraint (Forward)
            let cddForward = applyForwardLTSeparator(schedule.ETA.format(DATE_FORMAT), ltEtaToCdd);
            schedule.CDD = applyMonFriConstraintForward(cddForward);
            

            return {
                CDD: schedule.CDD.format(DISPLAY_FORMAT),
                ETA: schedule.ETA.format(DISPLAY_FORMAT),
                OrdersDue: ordersDueDateConstrained.format(DISPLAY_FORMAT),
                FabricETD: schedule.FabricETD.format(DISPLAY_FORMAT),
                FabInhouse: schedule.FabInhouse.format(DISPLAY_FORMAT),
                ETDBdesh: etdExBdesh.format(DISPLAY_FORMAT),
            };
        }


        // --- UI RENDERING & DATA MANAGEMENT ---

        function populateAnalysisDropdown() {
            // Function removed as per user request to remove Gemini section.
        }

        function addRow(defaultSeason, defaultDate) {
            const rowId = moment().valueOf(); // Unique ID
            dataRows.push({ 
                id: rowId, 
                season: defaultSeason, 
                inputDate: defaultDate 
            });
            localStorage.setItem('dataRows', JSON.stringify(dataRows));
            renderTable();
        }

        function removeRow(id) {
            dataRows = dataRows.filter(row => row.id !== id);
            localStorage.setItem('dataRows', JSON.stringify(dataRows));
            renderTable();
        }

        function addForwardRow(defaultScenario, defaultDate) {
            const rowId = moment().valueOf(); // Unique ID
            // Ensure default date adheres to Mon-Fri constraint
            let initialDate = moment(defaultDate);
            initialDate = applyMonFriConstraint(initialDate);

            forwardDataRows.push({ 
                id: rowId, 
                scenario: defaultScenario, 
                inputDate: initialDate.format(DATE_FORMAT) 
            });
            localStorage.setItem('forwardDataRows', JSON.stringify(forwardDataRows));
            renderForwardTable();
        }
        
        function removeForwardRow(id) {
            forwardDataRows = forwardDataRows.filter(row => row.id !== id);
            localStorage.setItem('forwardDataRows', JSON.stringify(forwardDataRows));
            renderForwardTable();
        }
        
        function updateForwardDate(id, newDate) {
            const row = forwardDataRows.find(r => r.id === id);
            if (row) {
                 // Ensure the input date adheres to Mon-Fri constraint
                let dateToSave = moment(newDate);
                dateToSave = applyMonFriConstraint(dateToSave);

                row.inputDate = dateToSave.format(DATE_FORMAT);
                localStorage.setItem('forwardDataRows', JSON.stringify(forwardDataRows));
                renderForwardTable();
            }
        }

        function updateForwardScenario(id, newScenario) {
            const row = forwardDataRows.find(r => r.id === id);
            if (row) {
                row.scenario = newScenario;
                localStorage.setItem('forwardDataRows', JSON.stringify(forwardDataRows));
                renderForwardTable();
            }
        }

        
        function updateDate(id, newDate) {
            const row = dataRows.find(r => r.id === id);
            if (row) {
                row.inputDate = newDate;
                localStorage.setItem('dataRows', JSON.stringify(dataRows));
                renderTable();
            }
        }

        function updateSeason(id, newSeason) {
            const row = dataRows.find(r => r.id === id);
            if (row) {
                row.season = newSeason;
                localStorage.setItem('dataRows', JSON.stringify(dataRows));
                renderTable();
            }
        }
        
        function recalculateAll() {
            renderTable();
            renderForwardTable();
            // populateAnalysisDropdown(); // Removed
        }

        function renderTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            if (dataRows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500">Click '+ Add Row' to start planning.</td></tr>`;
                return;
            }

            // Ensure Holiday set is updated before calculation
            updateHolidaySet();

            dataRows.forEach((row, index) => {
                const results = calculateSchedule(row.inputDate);
                const isViolation = results.CDD_CHECK;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                tr.innerHTML = `
                    <td class="px-3 py-3 text-center text-sm font-bold text-gray-900 border-r w-[140px]">
                        <input type="text" value="${row.season}" onchange="updateSeason(${row.id}, this.value)" class="w-full bg-transparent text-center font-bold">
                    </td>
                    <td class="px-3 py-3 text-center text-sm border-r w-[140px]">
                        <input type="date" value="${row.inputDate}" onchange="updateDate(${row.id}, this.value)" class="p-1 border rounded text-xs w-full">
                    </td>
                    <td class="px-3 py-3 text-center text-sm result-cell text-red-600 border-r w-[160px]">${results.OrdersDue}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell border-r w-[140px]">${results.ETA}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell border-r w-[140px]">${results.FabricETD}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell text-red-600 border-r w-[170px]">${results.FabInhouse}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell text-red-600 border-r w-[170px]">${results.ETDBdesh}</td>
                    <td class="px-3 py-3 text-center text-sm w-[40px]">
                        <button onclick="removeRow(${row.id})" class="text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // populateAnalysisDropdown(); // Removed
        }

        function renderForwardTable() {
            const tbody = document.getElementById('forwardResultsTableBody');
            tbody.innerHTML = '';

            if (forwardDataRows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center py-6 text-gray-500">Click '+ Add Forward Row' to simulate planning.</td></tr>`;
                return;
            }

            updateHolidaySet();

            forwardDataRows.forEach((row, index) => {
                const results = calculateForwardSchedule(row.inputDate);

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                tr.innerHTML = `
                    <td class="px-3 py-3 text-center text-sm font-bold text-gray-900 border-r w-[140px]">
                        <input type="text" value="${row.scenario}" onchange="updateForwardScenario(${row.id}, this.value)" class="w-full bg-transparent text-center">
                    </td>
                    <td class="px-3 py-3 text-center text-sm border-r w-[140px]">
                        <input type="date" value="${row.inputDate}" onchange="updateForwardDate(${row.id}, this.value)" class="p-1 border rounded text-xs w-full">
                    </td>
                    <td class="px-3 py-3 text-center text-sm result-cell text-red-600 border-r w-[160px]">${results.FabricETD}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell border-r w-[170px]">${results.FabInhouse}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell text-red-600 border-r w-[170px]">${results.ETDBdesh}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell border-r w-[140px]">${results.ETA}</td>
                    <td class="px-3 py-3 text-center text-sm result-cell border-r w-[140px]">${results.CDD}</td>
                    <td class="px-3 py-3 text-center text-sm w-[40px]">
                        <button onclick="removeForwardRow(${row.id})" class="text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }


        // --- Initialization ---
        
        function initializeApp() {
            // Attach listeners to fix 'openModal is not defined' error
            document.getElementById('settingsTriggerBtn').addEventListener('click', openModal);
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            
            // If no backward data is loaded, add initial example rows
            if (dataRows.length === 0) {
                // Example dates based on user's screenshot (2026 data)
                addRow('Spring 2026', '2026-01-25');
                addRow('Summer 2026', '2026-04-25');
                addRow('Fall 2026', '2026-07-25');
                addRow('Holiday 2026', '2026-10-25');
            }
            
            // If no forward data is loaded, add initial example rows
            if (forwardDataRows.length === 0) {
                // Example dates based on user's screenshot (2025/2026 data)
                addForwardRow('New Order 1', '2025-11-27');
                addForwardRow('New Order 2', '2025-11-20');
            }
            
            updateHolidaySet();
            renderTable();
            renderForwardTable();
        }

        window.onload = initializeApp;
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                if (icon) icon.textContent = '−'; 
            } else {
                section.classList.add('hidden');
                if (icon) icon.textContent = '+';
            }
        }
        
        
        // --- MODAL FUNCTIONS ---

        function openModal() {
            renderSettings();
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function renderSettings() {
            const ltContainer = document.getElementById('ltSettingsContainer');
            const holidayContainer = document.getElementById('holidaySettingsContainer');
            
            // Render LT Settings
            ltContainer.innerHTML = LTs.map((lt, index) => `
                <div class="flex space-x-2 items-center">
                    <input type="text" id="ltName${index}" value="${lt.name}" class="p-2 border rounded w-1/3 text-sm" placeholder="Lead Time Name">
                    <input type="number" id="ltDays${index}" value="${lt.days}" class="p-2 border rounded w-1/3 text-sm" placeholder="Days" min="1">
                    <select id="ltType${index}" class="p-2 border rounded w-1/3 text-sm">
                        <option value="working" ${lt.type === 'working' ? 'selected' : ''}>Working Days (Mon-Fri)</option>
                        <option value="calendar_holiday" ${lt.type === 'calendar_holiday' ? 'selected' : ''}>Calendar Days (Skip Holidays)</option>
                        <option value="calendar" ${lt.type === 'calendar' ? 'selected' : ''}>Calendar Days (7 Days)</option>
                    </select>
                </div>
            `).join('');

            // Render Holiday Settings
            holidayContainer.innerHTML = HOLIDAY_BLOCKS.map((h, index) => `
                <div class="flex space-x-1 items-center">
                    <input type="text" id="hName${index}" value="${h.name}" class="p-2 border rounded w-1/3 text-sm" placeholder="Holiday Name">
                    <input type="date" id="hStart${index}" value="${h.start}" class="p-2 border rounded w-1/3 text-sm" placeholder="Start Date">
                    <input type="date" id="hEnd${index}" value="${h.end}" class="p-2 border rounded w-1/3 text-sm" placeholder="End Date">
                    <button onclick="deleteHolidayBlock(${index})" class="text-red-500 hover:text-red-700 p-2 text-lg">
                        &times;
                    </button>
                </div>
            `).join('');

            // Add button to add more holiday blocks
            holidayContainer.innerHTML += `<button onclick="addHolidayBlock()" class="mt-3 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs py-1 px-3 rounded-md">+ Add Holiday Block</button>`;
        }

        function deleteHolidayBlock(index) {
             HOLIDAY_BLOCKS.splice(index, 1);
             localStorage.setItem('holidaySettings', JSON.stringify(HOLIDAY_BLOCKS));
             renderSettings(); // Re-render the modal content
        }

        function addHolidayBlock() {
            HOLIDAY_BLOCKS.push({ name: "New Holiday", start: moment().format(DATE_FORMAT), end: moment().add(3, 'days').format(DATE_FORMAT) });
            renderSettings();
        }

        function saveSettings() {
            const newLts = [];
            const newHolidayBlocks = [];

            // Save LTs
            LTs.forEach((_, index) => {
                const name = document.getElementById(`ltName${index}`).value;
                const days = parseInt(document.getElementById(`ltDays${index}`).value);
                const type = document.getElementById(`ltType${index}`).value;
                if (name && days > 0) {
                    newLts.push({ name, days, type });
                }
            });

            // Save Holiday Blocks
            HOLIDAY_BLOCKS.forEach((_, index) => {
                const name = document.getElementById(`hName${index}`).value;
                const start = document.getElementById(`hStart${index}`).value;
                const end = document.getElementById(`hEnd${index}`).value;
                if (name && moment(start).isValid() && moment(end).isValid()) {
                    newHolidayBlocks.push({ name, start, end });
                }
            });

            LTs = newLts;
            HOLIDAY_BLOCKS = newHolidayBlocks;

            localStorage.setItem('ltSettings', JSON.stringify(LTs));
            localStorage.setItem('holidaySettings', JSON.stringify(HOLIDAY_BLOCKS));

            updateHolidaySet();
            recalculateAll();
            closeModal();
        }
    </script>
</body>
</html>`
